<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng Nh·∫≠p - BookHaven</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body id="login-page-body">
    <header class="site-header">
        <div class="container header-container">
            <div class="logo">
                <a href="index.html">üìö BookHaven</a>
            </div>
            <nav class="main-nav">
                 <ul>
                    <li><a href="index.html">Trang Ch·ªß</a></li>
                    <li><a href="index.html#categories-section">Danh M·ª•c</a></li>
                    <li><a href="index.html#featured-books-section">T·∫•t C·∫£ S√°ch</a></li>
                </ul>
            </nav>
            <div class="header-actions" id="header-actions-container">
                {/* JS s·∫Ω c·∫≠p nh·∫≠t ph·∫ßn n√†y */}
                <a href="login.html" class="user-account active"><i class="fas fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p</a>
                <a href="register.html" class="user-register"><i class="fas fa-user-plus"></i> ƒêƒÉng K√Ω</a>
                <a href="cart.html" class="cart-link" aria-label="Gi·ªè h√†ng">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count">0</span>
                </a>
            </div>
             <button class="mobile-nav-toggle" aria-label="M·ªü menu" aria-expanded="false">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <main class="section-padding auth-page">
        <div class="container auth-container">
            <h1 class="section-title">ƒêƒÉng Nh·∫≠p T√†i Kho·∫£n</h1>
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="login-username">T√™n ƒëƒÉng nh·∫≠p ho·∫∑c Email:</label>
                    <input type="text" id="login-username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">M·∫≠t kh·∫©u:</label>
                    <input type="password" id="login-password" name="password" required>
                </div>
                <div class="form-message" id="login-message"></div>
                <button type="submit" class="btn btn-primary btn-block">ƒêƒÉng Nh·∫≠p</button>
            </form>
            <p class="auth-switch">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="register.html">ƒêƒÉng k√Ω ngay</a></p>
        </div>
    </main>

    <footer class="site-footer-bottom">
         <div class="container">
            <p>&copy; <span id="current-year"></span> BookHaven. B·∫£o l∆∞u m·ªçi quy·ªÅn.</p>
        </div>
    </footer>
    <script src="script.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ki·ªÉm tra n·∫øu c√≥ URL redirect sau khi ƒëƒÉng nh·∫≠p
        const loginForm = document.getElementById('login-form');
        
        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // L·∫•y gi√° tr·ªã email v√† password t·ª´ form
                const email = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                
                // X√°c th·ª±c t·ª´ localStorage (trong ·ª©ng d·ª•ng th·ª±c t·∫ø, ƒë√¢y s·∫Ω l√† API call)
                const users = JSON.parse(localStorage.getItem('bookHavenUsers')) || [];
                const user = users.find(u => (u.email === email || u.username === email));
                
                if (user && user.password === password) {
                    // X·ª≠ l√Ω chuy·ªÉn ƒë·ªïi gi·ªè h√†ng t·ª´ guest sang user
                    transferCartOnLogin(user.id);
                    
                    // Ki·ªÉm tra n·∫øu c√≥ s·∫£n ph·∫©m ƒëang ch·ªù th√™m v√†o gi·ªè h√†ng
                    const pendingCartItem = localStorage.getItem('bookHaven_pendingCartItem');
                    
                    // T·∫°o phi√™n ƒëƒÉng nh·∫≠p
                    const session = {
                        userId: user.id,
                        name: user.name || user.username,
                        email: user.email,
                        isAuthenticated: true,
                        loginTime: new Date().toISOString()
                    };
                    localStorage.setItem('bookHavenUserSession', JSON.stringify(session));
                    
                    // Th√¥ng b√°o th√†nh c√¥ng
                    document.getElementById('login-message').textContent = 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!';
                    document.getElementById('login-message').className = 'alert alert-success';
                    
                    // Th√™m s·∫£n ph·∫©m ƒëang ch·ªù v√†o gi·ªè h√†ng (n·∫øu c√≥)
                    if (pendingCartItem) {
                        const bookId = pendingCartItem;
                        const userCartName = `bookHavenCart_${user.id}`;
                        let userCart = JSON.parse(localStorage.getItem(userCartName)) || [];
                        
                        // T√¨m s√°ch trong danh s√°ch s·∫£n ph·∫©m
                        const books = JSON.parse(localStorage.getItem('bookHavenBooks')) || [];
                        const book = books.find(b => b.id === bookId);
                        
                        if (book) {
                            const existingItem = userCart.find(item => item.id === bookId);
                            
                            if (existingItem) {
                                existingItem.quantity += 1;
                            } else {
                                userCart.push({
                                    id: book.id,
                                    name: book.name,
                                    author: book.author,
                                    price: book.price,
                                    image: book.imageSrc,
                                    quantity: 1
                                });
                            }
                            
                            localStorage.setItem(userCartName, JSON.stringify(userCart));
                        }
                        
                        // X√≥a s·∫£n ph·∫©m ƒëang ch·ªù
                        localStorage.removeItem('bookHaven_pendingCartItem');
                    }
                    
                    // Ki·ªÉm tra URL chuy·ªÉn h∆∞·ªõng
                    const redirectUrl = localStorage.getItem('bookHaven_redirect_after_login');
                    if (redirectUrl) {
                        localStorage.removeItem('bookHaven_redirect_after_login');
                        setTimeout(function() {
                            window.location.href = redirectUrl;
                        }, 1000);
                    } else {
                        // N·∫øu kh√¥ng c√≥ URL chuy·ªÉn h∆∞·ªõng, v·ªÅ trang ch·ªß
                        setTimeout(function() {
                            window.location.href = 'index.html';
                        }, 1000);
                    }
                } else {
                    // Th√¥ng b√°o l·ªói
                    document.getElementById('login-message').textContent = 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
                    document.getElementById('login-message').className = 'alert alert-danger';
                }
            });
        }
        
        // H√†m chuy·ªÉn gi·ªè h√†ng t·ª´ ng∆∞·ªùi d√πng kh√°ch sang ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
        function transferCartOnLogin(userId) {
            // L·∫•y gi·ªè h√†ng c·ªßa kh√°ch
            const guestCart = JSON.parse(localStorage.getItem('bookHavenCart')) || [];
            
            // N·∫øu gi·ªè h√†ng c·ªßa kh√°ch tr·ªëng, kh√¥ng c·∫ßn chuy·ªÉn
            if (guestCart.length === 0) return;
            
            // L·∫•y gi·ªè h√†ng c·ªßa ng∆∞·ªùi d√πng (n·∫øu c√≥)
            const userCartName = `bookHavenCart_${userId}`;
            const userCart = JSON.parse(localStorage.getItem(userCartName)) || [];
            
            // K·∫øt h·ª£p hai gi·ªè h√†ng
            const mergedCart = [...userCart];
            
            // Th√™m t·ª´ng s·∫£n ph·∫©m t·ª´ gi·ªè h√†ng kh√°ch
            guestCart.forEach(guestItem => {
                // T√¨m s·∫£n ph·∫©m trong gi·ªè h√†ng ng∆∞·ªùi d√πng
                const existingItem = mergedCart.find(item => item.id === guestItem.id);
                
                if (existingItem) {
                    // N·∫øu s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i, c·ªông d·ªìn s·ªë l∆∞·ª£ng
                    existingItem.quantity += guestItem.quantity;
                } else {
                    // N·∫øu ch∆∞a c√≥, th√™m m·ªõi v√†o gi·ªè h√†ng ng∆∞·ªùi d√πng
                    mergedCart.push({...guestItem});
                }
            });
            
            // L∆∞u gi·ªè h√†ng ƒë√£ k·∫øt h·ª£p cho ng∆∞·ªùi d√πng
            localStorage.setItem(userCartName, JSON.stringify(mergedCart));
            
            // X√≥a gi·ªè h√†ng kh√°ch v√¨ ƒë√£ chuy·ªÉn sang gi·ªè h√†ng ng∆∞·ªùi d√πng
            localStorage.removeItem('bookHavenCart');
            
            console.log('ƒê√£ chuy·ªÉn gi·ªè h√†ng t·ª´ kh√°ch sang ng∆∞·ªùi d√πng:', userId);
        }
    });
</script>
</body>
</html>